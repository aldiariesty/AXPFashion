<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Produk - Admin Panel</title>
    <link href="/css/style.css" rel="stylesheet">
</head>
<body class="bg-slate-900 text-slate-200">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-white">Edit Produk</h1>
            <a href="/my-products.html" class="text-sky-400 hover:underline">‚Üê Kembali ke Daftar Produk</a>
        </header>

        <main id="edit-product-container" class="bg-slate-800 rounded-xl shadow-lg p-6 lg:p-8">
            <p>Memuat data produk...</p>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('edit-product-container');
            const urlParams = new URLSearchParams(window.location.search);
            const pid = urlParams.get('pid');

            if (!pid) {
                container.innerHTML = '<p class="text-red-400">Error: ID Produk (PID) tidak ditemukan di URL.</p>';
                return;
            }

            async function handleFormSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                const messageEl = document.getElementById('message');
                const submitButton = form.querySelector('button[type="submit"]');

                submitButton.disabled = true;
                submitButton.textContent = 'Menyimpan...';
                
                const variantsTable = document.getElementById('variants-table-body');
                const updatedVariants = [];
                variantsTable.querySelectorAll('tr').forEach(row => {
                    const variantData = {
                        vid: row.dataset.vid,
                        variantNameEn: row.dataset.name,
                        variantSku: row.dataset.sku,
                        variantSellPrice: parseFloat(row.dataset.originalPrice),
                        customSellPrice: parseFloat(row.querySelector('input[type="number"]').value),
                        isForSale: row.querySelector('input[type="checkbox"]').checked
                    };
                    updatedVariants.push(variantData);
                });
                formData.append('variants', JSON.stringify(updatedVariants));
                
                const galleryContainer = document.getElementById('gallery-container');
                const finalImageUrls = Array.from(galleryContainer.querySelectorAll('.gallery-thumbnail')).map(img => img.dataset.url);
                formData.append('existing_images', JSON.stringify(finalImageUrls));

                try {
                    const response = await fetch(`/api/product/${pid}`, {
                        method: 'POST',
                        body: formData
                    });
                    if (response.status === 401) {
                        alert('Sesi Anda telah habis. Silakan login kembali.');
                        window.location.href = '/login.html';
                        return;
                    }
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error);

                    messageEl.textContent = 'Perubahan berhasil disimpan! Halaman akan dimuat ulang...';
                    messageEl.className = 'mt-4 text-center text-green-400';
                    setTimeout(() => window.location.reload(), 2000);

                } catch (error) {
                    messageEl.textContent = `Error: ${error.message}`;
                    messageEl.className = 'mt-4 text-center text-red-400';
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Simpan Perubahan';
                }
            }

            function renderForm(product) {
                let galleryImages = [];
                try { galleryImages = JSON.parse(product.gallery_images || '[]'); } catch(e) {}
                let mainImage = product.main_image || galleryImages[0] || '';

                const galleryHTML = galleryImages.map(img => `
                    <div class="relative group">
                        <img src="/api/image-proxy?url=${encodeURIComponent(img)}" data-url="${img}" class="gallery-thumbnail w-24 h-24 object-cover rounded-lg cursor-pointer border-2 ${img === mainImage ? 'border-sky-500' : 'border-slate-700'}">
                        <button type="button" data-img-url="${img}" class="delete-img-btn absolute top-0 right-0 m-1 bg-red-600/80 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center opacity-0 group-hover:opacity-100">&times;</button>
                    </div>
                `).join('');

                let variants = [];
                try { variants = JSON.parse(product.variants || '[]'); } catch (e) {}
                const variantRows = variants.map((variant) => `
                    <tr class="divide-x divide-slate-700" data-vid="${variant.vid}" data-name="${variant.variantNameEn || ''}" data-sku="${variant.variantSku || ''}" data-original-price="${variant.variantSellPrice || 0}">
                        <td class="p-3 text-sm">${variant.variantNameEn || 'Default'}</td>
                        <td class="p-3 text-sm">${variant.variantSku}</td>
                        <td class="p-3 text-sm">$${variant.variantSellPrice}</td>
                        <td class="p-3"><input type="number" step="0.01" value="${variant.customSellPrice || ''}" class="w-full p-2 bg-slate-600 rounded-md"></td>
                        <td class="p-3 text-center"><input type="checkbox" ${variant.isForSale ? 'checked' : ''} class="w-5 h-5 rounded bg-slate-600"></td>
                    </tr>
                `).join('');

                container.innerHTML = `
                    <form id="edit-form">
                        <input type="hidden" name="main_image" id="main-image-input" value="${mainImage}">
                        
                        <div class="space-y-8">
                            <div>
                                <label for="name" class="block mb-2 text-sm font-medium">Nama Produk</label>
                                <input type="text" id="name" name="name" value="${product.name || ''}" class="w-full p-3 bg-slate-700 rounded-lg">
                            </div>
                            <div>
                                <label class="block mb-2 text-sm font-medium">Link Produk Asli</label>
                                <a href="${product.source_url}" target="_blank" class="text-sky-400 hover:underline break-all">${product.source_url || 'N/A'}</a>
                            </div>
                            
                            <div>
                                <label class="block mb-2 text-sm font-medium">Galeri Gambar</label>
                                <div id="gallery-container" class="flex flex-wrap gap-4 p-4 bg-slate-700/50 rounded-lg">${galleryHTML}</div>
                                <p class="mt-2 text-xs text-slate-400">Klik gambar untuk menjadikannya Gambar Utama.</p>
                            </div>

                            <div>
                                <label for="new_images" class="block mb-2 text-sm font-medium">Tambah Gambar Baru</label>
                                <input type="file" id="new_images" name="new_images" multiple class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100">
                            </div>
                            
                            <div>
                                <label class="block mb-4 text-lg font-semibold">Varian Produk</label>
                                <div class="overflow-x-auto bg-slate-700/50 rounded-lg">
                                    <table class="min-w-full"><thead class="bg-slate-700"><tr class="divide-x divide-slate-600"><th class="p-3 text-left text-xs uppercase">Nama Varian</th><th class="p-3 text-left text-xs uppercase">SKU</th><th class="p-3 text-left text-xs uppercase">Harga Supplier</th><th class="p-3 text-left text-xs uppercase">Harga Jual (USD)</th><th class="p-3 text-left text-xs uppercase">Jual?</th></tr></thead><tbody id="variants-table-body" class="divide-y divide-slate-700">${variantRows}</tbody></table>
                                </div>
                            </div>

                            <div>
                                <label for="description" class="block mb-2 text-sm font-medium">Deskripsi</label>
                                <textarea id="description" name="description" rows="8" class="w-full p-3 bg-slate-700 rounded-lg">${product.description || ''}</textarea>
                            </div>
                            <button type="submit" class="w-full p-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold">Simpan Perubahan</button>
                        </div>
                    </form>
                    <p id="message" class="mt-4 text-center"></p>
                `;
                
                const galleryContainer = document.getElementById('gallery-container');
                const mainImageInput = document.getElementById('main-image-input');
                
                galleryContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('gallery-thumbnail')) {
                        const selectedUrl = e.target.dataset.url;
                        mainImageInput.value = selectedUrl;
                        // Hapus highlight dari semua gambar
                        galleryContainer.querySelectorAll('.gallery-thumbnail').forEach(img => {
                            img.parentElement.classList.remove('border-sky-500');
                            img.parentElement.classList.add('border-slate-700');
                        });
                        // Tambahkan highlight ke gambar yang diklik
                        e.target.parentElement.classList.remove('border-slate-700');
                        e.target.parentElement.classList.add('border-sky-500');
                    }
                    if (e.target.classList.contains('delete-img-btn')) {
                        if (confirm('Anda yakin ingin menghapus gambar ini?')) {
                            e.target.parentElement.remove();
                        }
                    }
                });
                
                document.getElementById('edit-form').addEventListener('submit', handleFormSubmit);
            }

            async function main() {
                try {
                    const response = await fetch(`/api/product/${pid}`);
                    if (!response.ok) throw new Error('Gagal mengambil data produk.');
                    const product = await response.json();
                    renderForm(product);
                } catch (error) {
                    container.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
                }
            }

            main();
        });
    </script>
</body>
</html>
