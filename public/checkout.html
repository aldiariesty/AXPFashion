<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - AXPFashion</title>
    <link href="/css/style.css" rel="stylesheet">
</head>
<body class="bg-slate-900 text-slate-200">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <a href="/product.html" class="text-white text-3xl font-bold">AXP<span class="text-sky-500">.</span></a>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-12">
            <div class="bg-slate-800 rounded-xl shadow-lg p-6 lg:p-8">
                <h2 class="text-2xl font-semibold text-white mb-6">Informasi Pengiriman</h2>
                <form id="checkout-form" class="space-y-4">
                    <input type="text" id="customer_name" name="customer_name" placeholder="Nama Lengkap" class="w-full p-3 bg-slate-700 rounded-lg border border-slate-600" required>
                    <input type="tel" id="phone" name="phone" placeholder="Nomor Telepon (WhatsApp)" class="w-full p-3 bg-slate-700 rounded-lg border border-slate-600" required>
                    <textarea id="address" name="address" rows="3" placeholder="Alamat Lengkap (Nama Jalan, No. Rumah, RT/RW)" class="w-full p-3 bg-slate-700 rounded-lg border border-slate-600" required></textarea>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <input type="text" id="city" name="city" placeholder="Kota / Kabupaten" class="w-full p-3 bg-slate-700 rounded-lg border border-slate-600" required>
                        <input type="text" id="province" name="province" placeholder="Provinsi" class="w-full p-3 bg-slate-700 rounded-lg border border-slate-600" required>
                        <input type="text" id="zip" name="zip" placeholder="Kode Pos" class="w-full p-3 bg-slate-700 rounded-lg border border-slate-600" required>
                    </div>
                </form>
            </div>

            <div class="bg-slate-800 rounded-xl shadow-lg p-6 lg:p-8">
                <h2 class="text-2xl font-semibold text-white mb-6">Pesanan Anda</h2>
                <div id="order-summary-items" class="space-y-4 max-h-60 overflow-y-auto pr-2"></div>
                <div class="border-t border-slate-700 my-6 pt-6">
                    <div class="flex justify-between font-bold text-white text-lg">
                        <span>Total</span>
                        <span id="total-price">Rp 0</span>
                    </div>
                </div>
                <div class="space-y-3">
                    <label class="flex items-center p-4 bg-slate-700 rounded-lg cursor-pointer">
                        <input type="radio" name="payment_method" value="transfer" class="w-5 h-5 text-sky-600" checked>
                        <span class="ml-3 text-sm font-medium">Transfer Bank</span>
                    </label>
                </div>
                <button type="submit" form="checkout-form" id="submit-button" class="w-full mt-8 bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 rounded-lg">Buat Pesanan</button>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const orderSummaryItems = document.getElementById('order-summary-items');
            const totalPriceEl = document.getElementById('total-price');
            const checkoutForm = document.getElementById('checkout-form');
            const submitButton = document.getElementById('submit-button');

            function formatRupiah(number) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number); }

            function loadOrderSummary() {
                const cart = JSON.parse(localStorage.getItem('axpfashion_cart')) || [];
                orderSummaryItems.innerHTML = '';
                let subtotal = 0;
                if (cart.length === 0) { window.location.href = '/product.html'; return; }

                cart.forEach(item => {
                    subtotal += (item.price || 0) * (item.quantity || 0);
                    const imageUrl = (item.image && item.image.startsWith('/uploads/')) ? item.image : `/api/image-proxy?url=${encodeURIComponent(item.image || '')}`;
                    orderSummaryItems.innerHTML += `<div class="flex justify-between items-start text-sm"><div class="flex"><img src="${imageUrl}" class="w-12 h-12 object-cover rounded-md mr-3"><div><p class="font-medium text-white">${item.name || ''}</p><p class="text-slate-400">Qty: ${item.quantity || 0}</p></div></div><p class="text-slate-300">${formatRupiah((item.price || 0) * (item.quantity || 0))}</p></div>`;
                });
                totalPriceEl.textContent = formatRupiah(subtotal);
            }
            
            checkoutForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                submitButton.disabled = true;
                submitButton.textContent = 'Memproses...';

                const formData = new FormData(checkoutForm);
                const orderData = Object.fromEntries(formData.entries());
                
                orderData.cart = JSON.parse(localStorage.getItem('axpfashion_cart')) || [];

                if(orderData.cart.length === 0) {
                    alert('Keranjang Anda kosong!');
                    return;
                }

                try {
                    const response = await fetch('/api/orders', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderData)
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Gagal membuat pesanan.');

                    sessionStorage.setItem('last_order_id', result.order_id);
                    localStorage.removeItem('axpfashion_cart');
                    window.location.href = '/thankyou.html';

                } catch (error) {
                    alert(`Gagal membuat pesanan: ${error.message}`);
                    submitButton.disabled = false;
                    submitButton.textContent = 'Buat Pesanan';
                }
            });

            loadOrderSummary();
        });
    </script>
</body>
</html>
